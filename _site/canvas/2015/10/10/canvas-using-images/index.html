<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Using images</title>
  <meta name="description" content="canvas更有意思的一项特性就是图像操作能力。可以用于动态的图像合成或者作为图形的背景，以及游戏界面（Sprites）等等。浏览器支持的任意格式的外部图片都可以使用，比如PNG、GIF或者JPEG。 你甚至可以将同一个页面中其他canvas元素生成的图片作为图片源。">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="/canvas/2015/10/10/canvas-using-images/">
  <link rel="alternate" type="application/rss+xml" title="抠钉" href="/feed.xml" />
</head>


  <body>

    <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="/">抠钉</a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>

      <div class="trigger">
        
          
          <a class="page-link" href="/me/">Me</a>
          
        
          
        
          
        
          
        
          
        
          
          <a class="page-link" href="/tags/">Tags</a>
          
        
          <a class="page-link" href="/canvas/">canvas</a>
          <a class="page-link" href="/tips/">tips</a>
      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="post">

  <header class="post-header">
    <h1 class="post-title">Using images</h1>
    <p class="post-meta">Oct 10, 2015</p>
  </header>

  <article class="post-content">
    <p>canvas更有意思的一项特性就是图像操作能力。可以用于动态的图像合成或者作为图形的背景，以及游戏界面（Sprites）等等。浏览器支持的任意格式的外部图片都可以使用，比如PNG、GIF或者JPEG。 你甚至可以将同一个页面中其他canvas元素生成的图片作为图片源。</p>

<p>引入图像到canvas里需要以下两步基本操作：</p>

<ul>
  <li>获得一个指向 HTMLImageElement 的对象或者另一个canvas元素的引用作为源，也可以通过提供一个URL的方式来使用图片（参见例子）</li>
  <li>使用drawImage()函数将图片绘制到画布上</li>
</ul>

<h1 id="section">获得需要绘制的图片</h1>
<blockquote>
  <p>HTMLImageElement
  这些图片是由Image()函数构造出来的，或者任何的<img />元素
  HTMLVideoElement
  用一个HTML的 video元素作为你的图片源，可以从视频中抓取当前帧作为一个图像
  HTMLCanvasElement
  可以使用另一个 canvas 元素作为你的图片源。
  ImageBitmap
  这是一个高性能的位图，可以低延迟地绘制，它可以从上述的所有源以及其它几种源中生成。</p>
</blockquote>

<blockquote>
  <p>这些源统一由 CanvasImageSource类型来引用。</p>
</blockquote>

<p>有几种方式可以获取到我们需要在canvas上使用的图片。
## 使用相同页面内的图片
我们可以通过下列方法的一种来获得与canvas相同页面内的图片的引用：
* document.images集合
* document.getElementsByTagName()方法
* 如果你知道你想使用的指定图片的ID，你可以用document.getElementById()获得这个图片</p>

<h2 id="section-1">使用其它域名下的图片</h2>
<p>在 HTMLImageElement上使用crossOrigin属性，你可以请求加载其它域名上的图片。如果图片的服务器允许跨域访问这个图片，那么你可以使用这个图片而不污染canvas，否则，使用这个图片将会污染canvas。</p>

<h2 id="canvas-">使用其它 canvas 元素</h2>
<p>和引用页面内的图片类似地，用 document.getElementsByTagName 或 document.getElementById 方法来获取其它 canvas 元素。但你引入的应该是已经准备好的 canvas。</p>

<p>一个常用的应用就是将第二个canvas作为另一个大的 canvas 的缩略图。</p>

<h2 id="section-2">由零开始创建图像</h2>
<p>或者我们可以用脚本创建一个新的 HTMLImageElement 对象。要实现这个方法，我们可以使用很方便的Image()构造函数。</p>

<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">var</span> <span class="nx">img</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Image</span><span class="p">();</span>   <span class="c1">// 创建一个img元素</span>
<span class="nx">img</span><span class="p">.</span><span class="nx">src</span> <span class="o">=</span> <span class="s1">&#39;myImage.png&#39;</span><span class="p">;</span> <span class="c1">// 设置图片源地址</span></code></pre></div>

<p>当脚本执行后，图片开始装载。</p>

<p>若调用 drawImage 时，图片没装载完，那什么都不会发生（在一些旧的浏览器中可能会抛出异常）。因此你应该用load时间来保证不会在加载完毕之前使用这个图片：</p>

<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">var</span> <span class="nx">img</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Image</span><span class="p">();</span>   <span class="c1">// 创建img元素</span>
<span class="nx">img</span><span class="p">.</span><span class="nx">onload</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
  <span class="c1">// 执行drawImage语句</span>
<span class="p">}</span>
<span class="nx">img</span><span class="p">.</span><span class="nx">src</span> <span class="o">=</span> <span class="s1">&#39;myImage.png&#39;</span><span class="p">;</span> <span class="c1">// 设置图片源地址</span></code></pre></div>

<p>如果你只用到一张图片的话，这已经够了。但一旦需要不止一张图片，那就需要更加复杂的处理方法，但图片预装载策略超出本教程的范围，感兴趣的话可以参考 <a href="http://www.webreference.com/programming/javascript/gr/column3/">JavaScript Image Preloader</a>。</p>

<h2 id="data-url-">通过 data: url 方式嵌入图像</h2>
<p>我们还可以通过 data: url 方式来引用图像。Data urls 允许用一串 Base64 编码的字符串的方式来定义一个图片。</p>

<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">var</span> <span class="nx">img_src</span> <span class="o">=</span> <span class="s1">&#39;data:image/gif;base64,R0lGODlhCwALAIAAAAAA3pn/ZiH5BAEAAAEALAAAAAALAAsAAAIUhA+hkcuO4lmNVindo7qyrIXiGBYAOw==&#39;</span><span class="p">;</span></code></pre></div>

<p>其优点就是图片内容即时可用，无须再到服务器兜一圈。（还有一个优点是，可以将 CSS，JavaScript，HTML 和 图片全部封装在一起，迁移起来十分方便。）缺点就是图像没法缓存，图片大的话内嵌的 url 数据会相当的长：</p>

<h2 id="section-3">使用视频帧</h2>
<p>你还可以使用 video 中的视频帧（即便视频是不可见的）。例如，如果你有一个ID为“myvideo”的</p>

<div class="highlight"><pre><code class="language-html" data-lang="html"><span class="nt">&lt;video&gt;</span> 元素，你可以这样做：</code></pre></div>

<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">function</span> <span class="nx">getMyVideo</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">canvas</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;canvas&#39;</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">getContext</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">ctx</span> <span class="o">=</span> <span class="nx">canvas</span><span class="p">.</span><span class="nx">getContext</span><span class="p">(</span><span class="s1">&#39;2d&#39;</span><span class="p">);</span>

    <span class="k">return</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;myvideo&#39;</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></div>

<h1 id="section-4">绘制图片</h1>
<p>一旦获得了源图对象，我们就可以使用 drawImage 方法将它渲染到 canvas 里。drawImage 方法有三种形态，下面是最基础的一种。</p>

<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="nx">drawImage</span><span class="p">(</span><span class="nx">image</span><span class="p">,</span> <span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">)</span>
<span class="err">其中</span> <span class="nx">image</span> <span class="err">是</span> <span class="nx">image</span> <span class="err">或者</span> <span class="nx">canvas</span> <span class="err">对象，</span><span class="nx">x</span> <span class="err">和</span> <span class="nx">y</span> <span class="err">是其在目标</span> <span class="nx">canvas</span> <span class="err">里的起始坐标。</span></code></pre></div>

<p>例子：一个简单的线图
 &gt; 下面一个例子我用一个外部图像作为一线性图的背景。用背景图我们就不需要绘制负责的背景，省下不少代码。这里只用到一个 image 对象，于是就在它的 onload 事件响应函数中触发绘制动作。drawImage 方法将背景图放置在 canvas 的左上角 (0,0) 处。</p>

<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">function</span> <span class="nx">draw</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">ctx</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;canvas&#39;</span><span class="p">).</span><span class="nx">getContext</span><span class="p">(</span><span class="s1">&#39;2d&#39;</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">img</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Image</span><span class="p">();</span>
    <span class="nx">img</span><span class="p">.</span><span class="nx">onload</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
      <span class="nx">ctx</span><span class="p">.</span><span class="nx">drawImage</span><span class="p">(</span><span class="nx">img</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
      <span class="nx">ctx</span><span class="p">.</span><span class="nx">beginPath</span><span class="p">();</span>
      <span class="nx">ctx</span><span class="p">.</span><span class="nx">moveTo</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span><span class="mi">96</span><span class="p">);</span>
      <span class="nx">ctx</span><span class="p">.</span><span class="nx">lineTo</span><span class="p">(</span><span class="mi">70</span><span class="p">,</span><span class="mi">66</span><span class="p">);</span>
      <span class="nx">ctx</span><span class="p">.</span><span class="nx">lineTo</span><span class="p">(</span><span class="mi">103</span><span class="p">,</span><span class="mi">76</span><span class="p">);</span>
      <span class="nx">ctx</span><span class="p">.</span><span class="nx">lineTo</span><span class="p">(</span><span class="mi">170</span><span class="p">,</span><span class="mi">15</span><span class="p">);</span>
      <span class="nx">ctx</span><span class="p">.</span><span class="nx">stroke</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="nx">img</span><span class="p">.</span><span class="nx">src</span> <span class="o">=</span> <span class="s1">&#39;images/backdrop.png&#39;</span><span class="p">;</span>
  <span class="p">}</span></code></pre></div>

<h2 id="scaling">缩放 Scaling</h2>
<p>drawImage 方法的又一变种是增加了两个用于控制图像在 canvas 中缩放的参数。</p>

<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="nx">drawImage</span><span class="p">(</span><span class="nx">image</span><span class="p">,</span> <span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">,</span> <span class="nx">width</span><span class="p">,</span> <span class="nx">height</span><span class="p">)</span>
<span class="err">当中</span> <span class="nx">width</span> <span class="err">和</span> <span class="nx">height</span> <span class="err">分别是图像在</span> <span class="nx">canvas</span> <span class="err">中显示大小。</span></code></pre></div>

<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">function</span> <span class="nx">draw</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">ctx</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;canvas&#39;</span><span class="p">).</span><span class="nx">getContext</span><span class="p">(</span><span class="s1">&#39;2d&#39;</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">img</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Image</span><span class="p">();</span>
    <span class="nx">img</span><span class="p">.</span><span class="nx">onload</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
      <span class="k">for</span> <span class="p">(</span><span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="nx">i</span><span class="o">&lt;</span><span class="mi">4</span><span class="p">;</span><span class="nx">i</span><span class="o">++</span><span class="p">){</span>
        <span class="k">for</span> <span class="p">(</span><span class="nx">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="nx">j</span><span class="o">&lt;</span><span class="mi">3</span><span class="p">;</span><span class="nx">j</span><span class="o">++</span><span class="p">){</span>
          <span class="nx">ctx</span><span class="p">.</span><span class="nx">drawImage</span><span class="p">(</span><span class="nx">img</span><span class="p">,</span><span class="nx">j</span><span class="o">*</span><span class="mi">50</span><span class="p">,</span><span class="nx">i</span><span class="o">*</span><span class="mi">38</span><span class="p">,</span><span class="mi">50</span><span class="p">,</span><span class="mi">38</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="nx">img</span><span class="p">.</span><span class="nx">src</span> <span class="o">=</span> <span class="s1">&#39;images/rhino.jpg&#39;</span><span class="p">;</span>
  <span class="p">}</span></code></pre></div>

<h2 id="slicing">切片 Slicing</h2>
<p>drawImage 方法的第三个也是最后一个变种有8个新参数，用于控制做切片显示的。</p>

<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="nx">drawImage</span><span class="p">(</span><span class="nx">image</span><span class="p">,</span> <span class="nx">sx</span><span class="p">,</span> <span class="nx">sy</span><span class="p">,</span> <span class="nx">sWidth</span><span class="p">,</span> <span class="nx">sHeight</span><span class="p">,</span> <span class="nx">dx</span><span class="p">,</span> <span class="nx">dy</span><span class="p">,</span> <span class="nx">dWidth</span><span class="p">,</span> <span class="nx">dHeight</span><span class="p">)</span>
<span class="err">第一个参数和其它的是相同的，都是一个图像或者另一个</span> <span class="nx">canvas</span> <span class="err">的引用。</span>
<span class="err">其它</span><span class="mi">8</span><span class="err">个参数最好是参照右边的图解，前</span><span class="mi">4</span><span class="err">个是定义图像源的切片位置和大小，</span>
<span class="err">后</span><span class="mi">4</span><span class="err">个则是定义切片的目标显示位置和大小。</span></code></pre></div>

<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">function</span> <span class="nx">draw</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">canvas</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;canvas&#39;</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">ctx</span> <span class="o">=</span> <span class="nx">canvas</span><span class="p">.</span><span class="nx">getContext</span><span class="p">(</span><span class="s1">&#39;2d&#39;</span><span class="p">);</span>

  <span class="c1">// Draw slice</span>
  <span class="nx">ctx</span><span class="p">.</span><span class="nx">drawImage</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;source&#39;</span><span class="p">),</span>
                <span class="mi">33</span><span class="p">,</span><span class="mi">71</span><span class="p">,</span><span class="mi">104</span><span class="p">,</span><span class="mi">124</span><span class="p">,</span><span class="mi">21</span><span class="p">,</span><span class="mi">20</span><span class="p">,</span><span class="mi">87</span><span class="p">,</span><span class="mi">104</span><span class="p">);</span>

  <span class="c1">// Draw frame</span>
  <span class="nx">ctx</span><span class="p">.</span><span class="nx">drawImage</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;frame&#39;</span><span class="p">),</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span></code></pre></div>

<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">function</span> <span class="nx">draw</span><span class="p">()</span> <span class="p">{</span>

  <span class="c1">// Loop through all images</span>
  <span class="k">for</span> <span class="p">(</span><span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="nx">i</span><span class="o">&lt;</span><span class="nb">document</span><span class="p">.</span><span class="nx">images</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="nx">i</span><span class="o">++</span><span class="p">){</span>

    <span class="c1">// Don&#39;t add a canvas for the frame image</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">images</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">getAttribute</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span><span class="o">!=</span><span class="s1">&#39;frame&#39;</span><span class="p">){</span>

      <span class="c1">// Create canvas element</span>
      <span class="nx">canvas</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">&#39;CANVAS&#39;</span><span class="p">);</span>
      <span class="nx">canvas</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="s1">&#39;width&#39;</span><span class="p">,</span><span class="mi">132</span><span class="p">);</span>
      <span class="nx">canvas</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="s1">&#39;height&#39;</span><span class="p">,</span><span class="mi">150</span><span class="p">);</span>

      <span class="c1">// Insert before the image</span>
      <span class="nb">document</span><span class="p">.</span><span class="nx">images</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">parentNode</span><span class="p">.</span><span class="nx">insertBefore</span><span class="p">(</span><span class="nx">canvas</span><span class="p">,</span><span class="nb">document</span><span class="p">.</span><span class="nx">images</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>

      <span class="nx">ctx</span> <span class="o">=</span> <span class="nx">canvas</span><span class="p">.</span><span class="nx">getContext</span><span class="p">(</span><span class="s1">&#39;2d&#39;</span><span class="p">);</span>

      <span class="c1">// Draw image to canvas</span>
      <span class="nx">ctx</span><span class="p">.</span><span class="nx">drawImage</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">images</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span><span class="mi">15</span><span class="p">,</span><span class="mi">20</span><span class="p">);</span>

      <span class="c1">// Add frame</span>
      <span class="nx">ctx</span><span class="p">.</span><span class="nx">drawImage</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;frame&#39;</span><span class="p">),</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></div>

<h1 id="section-5">控制图像的缩放行为</h1>
<p>Gecko 1.9.2 引入了 mozImageSmoothingEnabled 属性，值为 false 时，图像不会平滑地缩放。默认是 true 。</p>

<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="nx">cx</span><span class="p">.</span><span class="nx">mozImageSmoothingEnabled</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span></code></pre></div>


  </article>

</div>

      </div>
    </div>

  </body>

</html>
